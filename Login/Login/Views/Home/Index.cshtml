@{
    ViewBag.Title = "Home Page";
}



<select name="distritos" id="distritos">
    <option value="0">Distrito 1</option>
    <option value="1">Distrito 1</option>
    <option value="2">Distrito 2</option>
    <option value="3">Distrito 3</option>
    <option value="24">Distrito 24</option>
</select>

<table class="table" id ="candidatosTable" style="width:100%;">
 
</table>
<input type="button" value="Click me" id="Calcular">

<table id="resultado" style="width:100%">

</table>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        class Candidato {
            
            constructor(Nombre, Lista, Partido, Sigla, Distrito, Voto) {
                this.Nombre = Nombre;
                this.Lista = Lista;
                this.Partido = Partido;
                this.Sigla = Sigla;
                this.Distrito = Distrito;
                if (Voto == "") {
                    Voto = 0;
                }
                //parseInt("23", 10)
                this.Voto = parseInt(Voto, 10);
                //alert(Voto);
            }
        }

        class CandidatoFinal {
            
            constructor(Nombre, Lista, Partido, Sigla, Distrito, Voto, VotoLista, VotoFinal) {
                this.Candidato = new Candidato(Nombre, Lista, Partido, Sigla, Distrito, Voto);
                this.VotoLista = VotoLista;
                this.VotoFinal = VotoFinal;
                //alert(Voto);
            }
        }

        class Lista {

            constructor(Nombre, Votos, Candidatos) {
                this.Nombre = Nombre;
                this.Votos = Votos;
                this.Candidatos = Candidatos;
            }
        }

        var ListaCandidatos = [];
        var Listas = []; //array.indexOf(2)
        var ListaConCandidatos = [];
        var ListaFinal = [];
        /*Con esta función al seleccionar un valor en el DropdownList Tema se rellenará automaticamente
         * el DropdownList de subtemas con los subtemas relacionados al Tema seleccionado
        */

        $(document).ready(function () {
            $("#distritos").change(function () {
                //alert("Hola");
                
                $.get("/Home/GetCandidatos", { id: $("#distritos").val() }, function (data) {
                    // VACIAMOS EL DropDownList
                    $("#candidatosTable").empty();
                    // AÑADIMOS UN NUEVO label CON EL NOMBRE DEL ELEMENTO SELECCIONADO
                    //$("#candidatos").append("<option value> Seleccionar Subtemas de " + $("#distritos option:selected").text() + " --</option>")
                    $("#candidatosTable").append("<tr style='background-color:red'>"+ 
                        "<th> Nombre</th>" +
                        "<th>Lista</th>" +
                        "<th>Partido</th>" +
                        "<th>Sigla</th>" +  
                        "<th>Distrito</th>" +  
                        "<th>Votos</th>" + 
                        "</tr > ")
                    // CONSTRUIMOS EL DropDownList A PARTIR DEL RESULTADO Json (data)
                    $.each(data, function (index, row) {
                        $("#candidatosTable").append("<tr>" +
                            "<td style='background-color:blue'>" + row.NOMBRE + "</td>" +
                            "<td>" + row.LISTA + "</td>" +
                            "<td>" + row.PARTIDO + "</td>" +
                            "<td>" + row.PARTIDOCORTO + "</td>" +
                            "<td>" + row.DISTRITO + "</td>" +
                            "<td> <input id='numero' type='number' min='0'> </td>" +
                            "</tr>")
                    });
                });
                
            });
        });

        $(document).ready(function () {
            $("#Calcular").click(function () {
                var table = document.getElementById("candidatosTable");
                var indx = 0;
                
                for (var i = 1, row; row = table.rows[i]; i++)
                {
                    ListaCandidatos.push(new Candidato(row.cells[0].innerHTML, row.cells[1].innerHTML, row.cells[2].innerHTML, row.cells[3].innerHTML, row.cells[4].innerHTML, document.getElementsByTagName("input")[indx].value));
                   
                    //alert(row.cells[0].innerHTML + row.cells[1].innerHTML + row.cells[2].innerHTML + row.cells[3].innerHTML + row.cells[4].innerHTML + document.getElementsByTagName("input")[indx].value)
                    if (Listas.indexOf(row.cells[1].innerHTML) == -1) {
                        Listas.push(row.cells[1].innerHTML);
                    }
                    indx++;
                       /*
                    for (var j = 0, col; col = row.cells[j]; j++)
                    {
                        //alert(col.innerHTML);
                    } 
                    */
                }
                //alert(ListaCandidatos[0].Nombre);
                //alert(ListaCandidatos[0].Lista);
                //alert(ListaCandidatos[0].Partido);
                //alert(ListaCandidatos[0].Sigla);
                //alert(ListaCandidatos[0].Distrito);
                //alert(ListaCandidatos[0].Voto);

                //const found = ListaCandidatos.filter(element => element.Partido == "INDEPENDIENTES");
                //alert(found.length);

                //const array1 = [5, 12, 8, 130, 44];

                //const found = array1.filter(element => element > 10);
                //alert(found.length)
                //alert(Listas);
                var found;
                //var acumulador;
                for (var i = 0, fila; fila = Listas[i]; i++) {
                    var ListaAux = [];
                    //alert(ListaCandidatos[0].Partido);
                    found = ListaCandidatos.filter(element => element.Lista === fila);
                    //alert(fila);
                    var acumulador = 0;
                    for (var j = 0, fila2; fila2 = found[j]; j++) {
                        //alert(j)
                        //alert(fila2.Voto);
                        acumulador = acumulador + fila2.Voto;
                        //alert(acumulador)
                        ListaAux.push(fila2.Nombre)
                        
                    }

                    ListaConCandidatos.push(new Lista(fila, acumulador, found.sort((a, b) => (a.Voto > b.Voto) ? -1 : 1)));
                }

                //alert(ListaConCandidatos[0].Nombre);
                //alert(ListaConCandidatos[0].Votos);
                //alert(ListaConCandidatos[0].Candidatos[0]);
                //alert(ListaAux[0].Nombre);
                //alert(ListaCandidatos.filter(element => element.Partido == ListaConCandidatos[0].Nombre)[0].Nombre);
                $("#resultado").empty();
                for (var i = 0, fila; fila = ListaConCandidatos.sort((a, b) => (a.Voto > b.Voto) ? -1 : 1)[i]; i++) {
                    for (var j = 0, fila2; fila2 = fila.Candidatos[j]; j++) {
                        //alert(fila2.Nombre)
                        //fila2.Voto = Math.round(fila.Votos / (j + 1));
                        ListaFinal.push(new CandidatoFinal(fila2.Nombre, fila2.Lista, fila2.Partido, fila2.Sigla, fila2.Distrito, fila2.Voto, fila.Votos, Math.round(fila.Votos / (j + 1))));
                    }                    
                }
                
                for (var i = 0, fila; fila = ListaFinal.sort((a, b) => (a.VotoFinal > b.VotoFinal) ? -1 : 1)[i]; i++) {
                    $("#resultado").append("<tr>" +
                        "<td>" + fila.Candidato.Nombre + "</td>" +
                        "<td>" + fila.Candidato.Lista + "</td>" +
                        "<td>" + fila.Candidato.Voto + "</td>" +
                        "<td>" + fila.VotoLista + "</td>" +
                        "<td>" + fila.VotoFinal + "</td>" +
                        /*
                        "<td>" + row.PARTIDOCORTO + "</td>" +
                        "<td>" + row.DISTRITO + "</td>" +
                        "<td> <input id='numero' type='number' min='0'> </td>" +
                        */
                        "</tr>");
                }
                /*
                var aux = new CandidatoFinal("Nombre", "Lista", "Partido", "Sigla", "Distrito", 2, 3, 4);
                alert(aux.Candidato.Nombre);
                alert(aux.Candidato.Sigla);
                alert(aux.Candidato.Voto);
                alert(aux.VotoLista);
                */
                //alert(parseInt("23", 10))
            });
        });
    </script>
}